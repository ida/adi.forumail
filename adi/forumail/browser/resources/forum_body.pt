<div id="forum-body" class="body posts" tal:define="
    mtool nocall: context/portal_membership;
    navroot_url string:${context/@@plone_portal_state/navigation_root_url};
    search_url string:${navroot_url}/@@search;
    forum_url view/getForumUrl;
    add_post_url view/getAddUrl;
    threaded view/isThreaded;
    posts nocall: view/getResults">
    <tal:repetitor tal:repeat="post posts"><!-- We don't repeat in parent-ele, to not redefine vars in it, for each loop, just once. -->
        <div class="post" tal:define="
            isIniPost nocall: view/isIniPost;
            getReplyDepthIter nocall: view/getReplyDepthIter;
            id post/id;
            title post/Title;
            categories post/Subject;
            author post/Creator;
            date post/CreationDate;
            date python: date[:10] + ' ' + date[12:16];
            url string:${forum_url}/${id};
            reply_url string:${add_post_url}&Title=${id};
            reply_depth_iter python: getReplyDepthIter(id);
            is_thread_ini python: isIniPost(id);
            text python: post.getObject().getText();">
            <div class="head">
                <a
                    tal:attributes='title string:See profile of "${author}";
                                    href string:${navroot_url}/author/${author};'
                        tal:define="portrait python: mtool.getPersonalPortrait(author);
                                    portrait_url portrait/absolute_url;
                                    default_img python: portrait_url.endswith('/defaultUser.png');">
                    <tal:exchangeDefaultPortrait tal:condition="default_img" tal:define="portrait_url string:${navroot_url}/logo.png">
                        <img class="avatar"
                            tal:attributes="src string:${portrait_url}; alt string:\
FallbackAvatar">
                    </tal:exchangeDefaultPortrait>
                    <img class="avatar"
                        tal:condition="not: default_img"
                        tal:attributes="src string:${portrait_url}; alt string:\
Avatar">
                </a>
                <span class="creation-date" tal:content="date">
2015-09-04 1:52
                </span>
                <a tal:content    = "title"
                   tal:condition  = "is_thread_ini"
                   tal:attributes = "class string:title;
                                     href string:${url}">
Title
                </a>
                <tal:notThreaded tal:condition="not: threaded">
                    <a tal:content    = "id"
                       tal:condition  = "not: is_thread_ini"
                       tal:attributes = "class string:id;
                                         href string:${url}">
Id
                    </a>
                </tal:notThreaded>
                <span class="categories"
                    tal:content="categories">
Category
                </span>
                <a class="reply link"
                 tal:attributes='href reply_url;
                                 title string:Reply to "${id}";'>
Reply
                </a>
            </div>
            <tal:vizReplyDepth tal:repeat="i reply_depth_iter" tal:define="opening_div string:&lt;div&gt;" tal:content="structure opening_div"/>
            <div class="text" tal:content="structure text">
Text
            </div>
            <tal:vizReplyDepth tal:repeat="i reply_depth_iter" tal:define="closing_div string:&lt;/div&gt;" tal:content="structure closing_div"/>
        </div>
    </tal:repetitor>
</div>

