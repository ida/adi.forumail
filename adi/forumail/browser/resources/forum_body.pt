<tal:comment tal:replace="nothing">Exceptionally we use an id here, to be able to use jQ's .load(), see: './magic.js'.</tal:comment>
<div id="forum-body" class="body posts" tal:define="
    mtool nocall: context/portal_membership;
    navroot_url string:${context/@@plone_portal_state/navigation_root_url};
    search_url string:${navroot_url}/@@search;
    forum_url view/getForumUrl;
    add_post_url view/getAddUrl;
    threaded view/isThreaded;
    posts nocall: view/getResults">
    <tal:repetitor tal:repeat="post posts">
        <div class="post" tal:define="
            isIniPost nocall: view/isIniPost;
            id post/id;
            title post/Title;
            categories post/Subject;
            author post/Creator;
            date post/CreationDate;
            date python: date[:10] + ' ' + date[12:16];
            url string:${forum_url}/${id};
            reply_url string:${add_post_url}&Title=${id};
            is_thread_ini python: isIniPost(id);
            text python: post.getObject().getText();">
            <div class="head">
                <div class="categories">
                    <a class="category link"
                        tal:repeat="cat categories"
                        tal:content="cat"
                        tal:attributes="href string:${search_url}?Subject%3Alist=${cat};
                                        title string:Go to all posts tagged with '${cat}';">
Category
                    </a>
                </div>
                <a
                    tal:attributes='title string:See profile of "${author}";
                                    href string:${navroot_url}/author/${author};'
                        tal:define="portrait python: mtool.getPersonalPortrait(author);
                                    portrait_url portrait/absolute_url;
                                    default_img python: portrait_url.endswith('/defaultUser.png');">
                    <tal:exchangeDefaultPortrait tal:condition="default_img" tal:define="portrait_url string:${navroot_url}/logo.png">
                        <img class="avatar"
                            tal:attributes="src string:${portrait_url}; alt string:\
FallbackAvatar">
                    </tal:exchangeDefaultPortrait>
                    <img class="avatar"
                        tal:condition="not: default_img"
                        tal:attributes="src string:${portrait_url}; alt string:\
Avatar">
                </a>
                <span tal:content="date" />
                <a tal:content    = "title"
                   tal:condition  = "is_thread_ini"
                   tal:attributes = "class string:title;
                                     href string:${url}">
Title
                </a>
<!--
                <tal:notThreaded tal:condition="not: threaded">
-->
                    <a tal:content    = "id"
                       tal:condition  = "not: is_thread_ini"
                       tal:attributes = "class string:id;
                                         href string:${url}">
Id
                    </a>
<!--
                </tal:notThreaded>
-->
            </div><tal:comment tal:replace="nothing">EO .post .head</tal:comment>
            <div class="body text" tal:content="structure text">
Text
            </div>
            <div class="foot">
                <a class="reply link"
                 tal:attributes='href reply_url;
                                 title string:Reply to "${id}";'>
Reply
                </a>
            </div>
        </div><tal:comment tal:replace="nothing">EO .post</tal:comment>
    </tal:repetitor>
</div><tal:comment tal:replace="nothing">EO .posts</tal:comment>

